var carouselModule;

(function ($) {
    
   carouselModule = function(sources){

      let carousel, vtree$, watchCarousel$, clickStreamRight$, clickStreamLeft$, carouselItems;

      watchCarousel$ = sources.DOM.select('.carousel')
                       .observable
                       .subscribe((el)=>{
                            if(el.length){
                                carousel = $(el).carousel();
                                watchCarousel$.dispose();
                            }   
                        });

      clickStreamRight$ = sources.DOM.select('.carousel .carousel-item .right')
                          .events('click')
                          .map(ev => 1);

      clickStreamLeft$ = sources.DOM.select('.carousel .carousel-item .left')
                         .events('click')
                         .map(ev => -1);

      Rx.Observable.merge(clickStreamRight$, clickStreamLeft$)
                   .subscribe((indicator)=>{
                       setTimeout(function(){
                         carousel.carousel('next',indicator);  
                       },250)  
                   });
       
      carouselItems = getCarouselDateList();

      vtree$ = Rx.Observable.of(
                div('.carousel .carousel-slider .center .noselect',
                    carouselItems.map((data)=>{
                        return carouselItemTree$(sources,{month:data.month,year:data.year,title:data.monthString,color:data.color}).DOM;     
                    })
                )
               );

      return {
        DOM: vtree$
      };
  }
   
  function carouselItemTree$(sources,info){
      let vtree$;
      vtree$ = Rx.Observable.of(
        div('.carousel-item .' + info.color + ' .white-text',{attrs:{data:{month:info.month,year:info.year}}},[
          h2(info.title),
          button('.arrow .left',[
            i(),
            i()
          ]),
          button('.arrow .right',[
            i(),
            i()
          ]),
        ])    
      );
      
      return {
          DOM: vtree$
      }
  }
  
  let colorArray = ['red','amber','green','blue','purple','indigo','lime','cyan','teal'];
    
  function getCarouselDateList(dateString){
      
      let dateObj = utility.getDateObject(dateString), dates = [], i;
      dateObj.date.setDate(1);
      
      userData.currentMonth = dateObj.month;
      userData.currentYear = dateObj.year;
      
      dates.push(getCarouselDate(dateObj,0));
      
      for(i = 1;i <= 4;i++){
        dateObj.date.setMonth(dateObj.date.getMonth()+1);
        dates.push(getCarouselDate(dateObj,i));
      }
      
      dateObj.date.setMonth(dateObj.date.getMonth()-9);
      
      for(i = 5;i <= 8;i++){
        dateObj.date.setMonth(dateObj.date.getMonth()+1);
        dates.push(getCarouselDate(dateObj,i));
      }
      return dates;
  }
  
  function getCarouselDate(dateObj,i){
      month = dateObj.date.getMonth()+1;
      year = dateObj.date.getFullYear(); 
      return {'year':year,'month':month,'monthString':utility.monthMap[month] + ' ' + year,'color':colorArray[i]};
  }
   
  //functionality

  var methods = {

    init : function(options) {
      var defaults = {
        time_constant: 300, // ms
        dist: -100, // zoom scale TODO: make this more intuitive as an option
        shift: 0, // spacing for center image
        padding: 0, // Padding between non center items
        full_width: true, // Change to full width styles
        no_wrap: false // Don't wrap around and cycle through items.
      };
      options = $.extend(defaults, options);

      var timeFrameInfo = utility.getDateObject();

      return this.each(function() {

        var images, offset, center, pressed, dim, count,
            reference, referenceY, amplitude, target, velocity,
            xform, frame, timestamp, ticker, dragged, vertical_dragged;

        // Initialize
        var view = $(this);

        // Don't double initialize.
        if (view.hasClass('initialized')) {
          // Redraw carousel.
          $(this).trigger('carouselNext', [0.000001]);
          return true;
        }


        // Options
        if (options.full_width) {
          options.dist = 0;
          var firstImage = view.find('.carousel-item img').first();
          if (firstImage.length) {
            imageHeight = firstImage.load(function(){
              view.css('height', $(this).height());
            });
          } else {
            imageHeight = view.find('.carousel-item').first().height();
            view.css('height', imageHeight);
          }
        }

        view.addClass('initialized');
        pressed = false;
        offset = target = 0;
        images = [];
        item_width = view.find('.carousel-item').first().innerWidth();
        dim = (item_width * 2 + options.padding);

        view.find('.carousel-item').each(function (i) {
          images.push($(this)[0]);
        });

        count = images.length;

        function setupEvents() {
          if (typeof window.ontouchstart !== 'undefined') {
            view[0].addEventListener('touchstart', tap);
            view[0].addEventListener('touchmove', drag);
            view[0].addEventListener('touchend', release);
          }
          view[0].addEventListener('mousedown', tap);
          view[0].addEventListener('mousemove', drag);
          view[0].addEventListener('mouseup', release);
          view[0].addEventListener('mouseleave', release);
          view[0].addEventListener('click', click);
        }

        function xpos(e) {
          // touch event
          if (e.targetTouches && (e.targetTouches.length >= 1)) {
            return e.targetTouches[0].clientX;
          }

          // mouse event
          return e.clientX;
        }

        function ypos(e) {
          // touch event
          if (e.targetTouches && (e.targetTouches.length >= 1)) {
            return e.targetTouches[0].clientY;
          }

          // mouse event
          return e.clientY;
        }

        function wrap(x) {
          return (x >= count) ? (x % count) : (x < 0) ? wrap(count + (x % count)) : x;
        }

        function scroll(x,final) {
          var i, half, delta, dir, tween, el, alignment, xTranslation;

          offset = (typeof x === 'number') ? x : offset;
          center = Math.floor((offset + dim / 2) / dim);
          delta = offset - center * dim;
          dir = (delta < 0) ? 1 : -1;
          tween = -dir * delta * 2 / dim;
          half = count >> 1;

          if (!options.full_width) {
            alignment = 'translateX(' + (view[0].clientWidth - item_width) / 2 + 'px) ';
            alignment += 'translateY(' + (view[0].clientHeight - item_width) / 2 + 'px)';
          } else {
            alignment = 'translateX(0)';
          }

          // center
          // Don't show wrapped items.
          if (!options.no_wrap || (center >= 0 && center < count)) {
            el = images[wrap(center)];
              
            if(timeFrameInfo.month !== el.attrs.data.month || timeFrameInfo.year !== el.attrs.data.year){
                let $el, indexOffset, updateEl, temp;
                timeFrameInfo.month = el.attrs.data.month;
                timeFrameInfo.year = el.attrs.data.year;
                
                let dateList = getCarouselDateList(timeFrameInfo.month+'/01/'+timeFrameInfo.year); // expecting 0 index.
                
                $el = $(el);
                indexOffset = $(el).index();
                
                for(i = 0; i < indexOffset; i++){
                    temp = dateList.pop();
                    dateList.unshift(temp);    
                }
                
                $(el.parentElement).find('.carousel-item').map((index,element)=>{
                    //console.log(userData.presentYear);
                    //console.log(userData.presentMonth);
                    element.attrs.data.month = dateList[index].month;
                    element.attrs.data.year = dateList[index].year;
                    element.firstChild.innerText = utility.monthMap[element.attrs.data.month] + ' ' + element.attrs.data.year;
                });
                
                utility.populateValues(); // other logic here.

            }
              
            el.style[xform] = alignment +
              ' translateX(' + (-delta / 2) + 'px)' +
              ' translateX(' + (dir * options.shift * tween * i) + 'px)' +
              ' translateZ(' + (options.dist * tween) + 'px)';
            el.style.zIndex = 0;
            if (options.full_width) { tweenedOpacity = 1; }
            else { tweenedOpacity = 1 - 0.2 * tween; }
            el.style.opacity = tweenedOpacity;
            el.style.display = 'block';
          }

          for (i = 1; i <= half; ++i) {
            // right side
            if (options.full_width) {
              zTranslation = options.dist;
              tweenedOpacity = (i === half && delta < 0) ? 1 - tween : 1;
            } else {
              zTranslation = options.dist * (i * 2 + tween * dir);
              tweenedOpacity = 1 - 0.2 * (i * 2 + tween * dir);
            }
            // Don't show wrapped items.
            if (!options.no_wrap || center + i < count) {
              el = images[wrap(center + i)];
              el.style[xform] = alignment +
                ' translateX(' + (options.shift + (dim * i - delta) / 2) + 'px)' +
                ' translateZ(' + zTranslation + 'px)';
              el.style.zIndex = -i;
              el.style.opacity = tweenedOpacity;
              el.style.display = 'block';
            }


            // left side
            if (options.full_width) {
              zTranslation = options.dist;
              tweenedOpacity = (i === half && delta > 0) ? 1 - tween : 1;
            } else {
              zTranslation = options.dist * (i * 2 - tween * dir);
              tweenedOpacity = 1 - 0.2 * (i * 2 - tween * dir);
            }
            // Don't show wrapped items.
            if (!options.no_wrap || center - i >= 0) {
              el = images[wrap(center - i)];
              el.style[xform] = alignment +
                ' translateX(' + (-options.shift + (-dim * i - delta) / 2) + 'px)' +
                ' translateZ(' + zTranslation + 'px)';
              el.style.zIndex = -i;
              el.style.opacity = tweenedOpacity;
              el.style.display = 'block';
            }
          }

          // center
          // Don't show wrapped items.
          if (!options.no_wrap || (center >= 0 && center < count)) {
            el = images[wrap(center)];
            el.style[xform] = alignment +
              ' translateX(' + (-delta / 2) + 'px)' +
              ' translateX(' + (dir * options.shift * tween) + 'px)' +
              ' translateZ(' + (options.dist * tween) + 'px)';
            el.style.zIndex = 0;
            if (options.full_width) { tweenedOpacity = 1; }
            else { tweenedOpacity = 1 - 0.2 * tween; }
            el.style.opacity = tweenedOpacity;
            el.style.display = 'block';
          }
        }

        function track() {
          var now, elapsed, delta, v;

          now = Date.now();
          elapsed = now - timestamp;
          timestamp = now;
          delta = offset - frame;
          frame = offset;

          v = 1000 * delta / (1 + elapsed);
          velocity = 0.8 * v + 0.2 * velocity;
        }

        function autoScroll() {
          var elapsed, delta;
          if (amplitude) {
            elapsed = Date.now() - timestamp;
            delta = amplitude * Math.exp(-elapsed / options.time_constant);
            if (delta > 2 || delta < -2) {
                scroll(target - delta);
                requestAnimationFrame(autoScroll);
            } else {
                scroll(target,true);
            }
          }
        }

        function click(e) {
          // Disable clicks if carousel was dragged.
          if (dragged) {
            e.preventDefault();
            e.stopPropagation();
            return false;

          } else if (!options.full_width) {
            var clickedIndex = $(e.target).closest('.carousel-item').index();
            var diff = (center % count) - clickedIndex;

            // Disable clicks if carousel was shifted by click
            if (diff !== 0) {
              e.preventDefault();
              e.stopPropagation();
            }
            cycleTo(clickedIndex);
          }
        }

        function cycleTo(n) {
          var diff = (center % count) - n;

          // Account for wraparound.
          if (!options.no_wrap) {
            if (diff < 0) {
              if (Math.abs(diff + count) < Math.abs(diff)) { diff += count; }

            } else if (diff > 0) {
              if (Math.abs(diff - count) < diff) { diff -= count; }
            }
          }

          // Call prev or next accordingly.
          if (diff < 0) {
            view.trigger('carouselNext', [Math.abs(diff)]);

          } else if (diff > 0) {
            view.trigger('carouselPrev', [diff]);
          }
        }

        function tap(e) {
          pressed = true;
          dragged = false;
          vertical_dragged = false;
          reference = xpos(e);
          referenceY = ypos(e);

          velocity = amplitude = 0;
          frame = offset;
          timestamp = Date.now();
          clearInterval(ticker);
          ticker = setInterval(track, 100);

        }

        function drag(e) {
          var x, delta, deltaY;
          if (pressed) {
            x = xpos(e);
            y = ypos(e);
            delta = reference - x;
            deltaY = Math.abs(referenceY - y);
            if (deltaY < 30 && !vertical_dragged) {
              // If vertical scrolling don't allow dragging.
              if (delta > 2 || delta < -2) {
                dragged = true;
                reference = x;
                scroll(offset + delta);
              }

            } else if (dragged) {
              // If dragging don't allow vertical scroll.
              e.preventDefault();
              e.stopPropagation();
              return false;

            } else {
              // Vertical scrolling.
              vertical_dragged = true;
            }
          }

          if (dragged) {
            // If dragging don't allow vertical scroll.
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        }

        function release(e) {
          if (pressed) {
            pressed = false;
          } else {
            return;
          }

          clearInterval(ticker);
          target = offset;
          if (velocity > 10 || velocity < -10) {
            amplitude = 0.9 * velocity;
            target = offset + amplitude;
          }
          target = Math.round(target / dim) * dim;

          // No wrap of items.
          if (options.no_wrap) {
            if (target >= dim * (count - 1)) {
              target = dim * (count - 1);
            } else if (target < 0) {
              target = 0;
            }
          }
          amplitude = target - offset;
          timestamp = Date.now();
          requestAnimationFrame(autoScroll);

          if (dragged) {
            //remove to active mouseup event in main
            e.preventDefault();
            e.stopPropagation();
          }
          return false;
        }

        xform = 'transform';
        ['webkit', 'Moz', 'O', 'ms'].every(function (prefix) {
          var e = prefix + 'Transform';
          if (typeof document.body.style[e] !== 'undefined') {
            xform = e;
            return false;
          }
          return true;
        });

        window.onresize = scroll;

        setupEvents();
        scroll(offset);

        $(this).on('carouselNext', function(e, n) {
          if (n === undefined) {
            n = 1;
          }
          target = offset + dim * n;
          if (offset !== target) {
            amplitude = target - offset;
            timestamp = Date.now();
            requestAnimationFrame(autoScroll);
          }
        });

        $(this).on('carouselPrev', function(e, n) {
          if (n === undefined) {
            n = 1;
          }
          target = offset - dim * n;
          if (offset !== target) {
            amplitude = target - offset;
            timestamp = Date.now();
            requestAnimationFrame(autoScroll);
          }
        });

        $(this).on('carouselSet', function(e, n) {
          if (n === undefined) {
            n = 0;
          }
          cycleTo(n);
        });

      });

    },
    next : function(n) {
      $(this).trigger('carouselNext', [n]);
    },
    prev : function(n) {
      $(this).trigger('carouselPrev', [n]);
    },
    set : function(n) {
      $(this).trigger('carouselSet', [n]);
    }
  };

    $.fn.carousel = function(arg,indicator) {
        if(methods[arg]){
            return methods[arg].apply(this,[indicator]);    
        }
        return methods.init.apply(this);
    }; // Plugin end
    
}( jQuery ));